<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Entradas (almacenes top-level) – La Proveedora</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{ --azul:#00416A; --ok:#1e8e3e; --bg:linear-gradient(to right,#00416A,#E4E5E6);
           --card:rgba(255,255,255,.96); --shadow:0 10px 28px rgba(0,0,0,.16); --radius:16px; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,Arial; background:var(--bg); color:#0f172a;
          min-height:100vh; padding:20px; display:flex; justify-content:center; }
    .wrap{width:100%; max-width:900px; display:grid; gap:18px}
    header{ background:#003456; color:#fff; padding:14px 16px; border-radius:var(--radius);
            box-shadow:var(--shadow); text-align:center; font-weight:600; }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }
    h2{margin:.2rem 0 1rem; font-size:1.1rem; color:#0b2740}
    label{font-size:.9rem; display:block; margin:10px 0 6px}
    input,select{ width:100%; padding:10px 12px; border:1px solid #cfd8e3; border-radius:10px; background:#fff; }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{ background:var(--azul); color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; }
    .muted{color:#5b6b7a; font-size:.88rem} .ok{color:var(--ok); font-weight:600}
    .hr{height:1px; background:#e6e9ef; margin:14px 0}
    .list{max-height:320px; overflow:auto; border:1px dashed #d5dbe4; border-radius:12px; padding:8px}
    .item{display:flex; justify-content:space-between; padding:8px 10px; border-radius:10px}
    .item:nth-child(odd){background:#fafbff}
    .pill{padding:3px 8px; border-radius:999px; background:#eef2f7; font-size:.78rem}
  </style>
</head>
<body>
  <div class="wrap">
    <header>ENTRADAS · Almacenes (top-level) → stock + log por ruta</header>

    <section class="card">
      <h2>Registrar entrada (+)</h2>

      <div class="row">
        <div>
          <label for="selRuta">Ruta (identificador)</label>
          <select id="selRuta"></select>
        </div>
        <div>
          <label for="selAlmacen">Almacén (colección <b>almacenes</b>)</label>
          <select id="selAlmacen"></select>
          <div class="muted" id="hintAlm"></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="selProducto">Producto</label>
          <select id="selProducto"></select>
        </div>
        <div>
          <label for="cantidad">Cantidad</label>
          <input id="cantidad" type="number" min="1" step="1" placeholder="0">
        </div>
      </div>

      <div style="margin-top:10px">
        <button id="btnEntrada" class="btn">Agregar entrada (+)</button>
        <span id="msg" class="muted"></span>
      </div>

      <div class="hr"></div>
      <h2>Últimas entradas (sesión)</h2>
      <div id="movList" class="list"></div>
    </section>
  </div>

  <!-- Firebase (CDN, ESM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      initializeFirestore,
      doc, setDoc, getDoc, collection, getDocs, query, orderBy,
      serverTimestamp, writeBatch, increment
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // === TU CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = initializeFirestore(app, { experimentalAutoDetectLongPolling:true, useFetchStreams:false });

    // === UI ===
    const $ = id => document.getElementById(id);
    const selRuta = $("selRuta"), selAlmacen = $("selAlmacen"), selProducto = $("selProducto");
    const cantidad = $("cantidad"), btnEntrada = $("btnEntrada"), msg = $("msg"), movList = $("movList");
    const hintAlm = $("hintAlm");

    const state = { rutas:[], almacenes:[], productos:[], entradas:[] };

    function toast(text, ok=false){ msg.textContent=text; msg.className= ok? "ok":"muted"; }

    // === Cargar catálogos ===
    async function cargarRutas(){
      const snap = await getDocs(collection(db,"rutas_venta"));
      state.rutas = snap.docs.map(d=>({id:d.id}));
      selRuta.innerHTML = state.rutas.map(r=>`<option value="${r.id}">${r.id}</option>`).join("") || `<option value="">(sin rutas)</option>`;
    }
    async function cargarAlmacenes(){
      const qSnap = await getDocs(query(collection(db,"almacenes"), orderBy("id"))); // si no hay campo id, ordena por nombre luego
      state.almacenes = qSnap.docs.map(d=>({id:d.id, ...d.data()}));
      renderAlmacenes(); // primera carga (sin filtro)
    }
    async function cargarProductos(){
      const snap = await getDocs(collection(db,"productos"));
      state.productos = snap.docs.map(d=>({id:d.id, ...d.data()}));
      selProducto.innerHTML = state.productos
        .sort((a,b)=>(a.descripcion||a.id).localeCompare(b.descripcion||b.id))
        .map(p=>`<option value="${p.id}">${(p.descripcion||p.nombre||p.id)} ${p.codigo?("· "+p.codigo):""}</option>`).join("")
        || `<option value="">(sin productos)</option>`;
    }

    // Filtrado de almacenes según ruta:
    // 1) Si el doc de 'almacenes' trae campo rutaId, se usa ese.
    // 2) Si no, se aplica convención por nombre: 'Almacen_Ruta_#' a partir del id de la ruta seleccionada.
    function renderAlmacenes(){
      const rutaId = selRuta.value; // ej. "ruta_2"
      let filtered = state.almacenes;

      if(rutaId){
        const byField = state.almacenes.filter(a => (a.rutaId && a.rutaId === rutaId));
        if(byField.length){
          filtered = byField;
          hintAlm.textContent = "Filtrado por campo rutaId en documentos de 'almacenes'.";
        }else{
          // convención por nombre
          const suf = rutaId.replace("ruta_", "Ruta_"); // "Ruta_2"
          const needle = `Almacen_${suf}`;            // "Almacen_Ruta_2"
          filtered = state.almacenes.filter(a => a.id === needle || (a.nombre && a.nombre.includes(suf)));
          hintAlm.textContent = `Filtrado por convención de nombre: ${needle}`;
        }
      }else{
        hintAlm.textContent = "Selecciona una ruta para sugerir su almacén.";
      }

      selAlmacen.innerHTML = filtered.map(a=>`<option value="${a.id}">${a.nombre||a.id}</option>`).join("")
        || `<option value="">(sin coincidencias; selecciona manualmente)</option>`;
    }

    selRuta.addEventListener("change", renderAlmacenes);

    // === ENTRADA (+) ===
    btnEntrada.addEventListener("click", async ()=>{
      const rutaId = selRuta.value;
      const almacenId = selAlmacen.value;
      const productoId = selProducto.value;
      const cant = Number(cantidad.value);

      if(!rutaId){ toast("Selecciona una ruta."); return; }
      if(!almacenId){ toast("Selecciona un almacén (colección 'almacenes')."); return; }
      if(!productoId){ toast("Selecciona un producto."); return; }
      if(!cant || cant<=0){ toast("Cantidad inválida."); return; }

      try{
        // Stock en el almacén top-level
        const exisRef = doc(db, "almacenes", almacenId, "existencias", productoId);
        // Log por ruta
        const logRef  = collection(db, "rutas_venta", rutaId, "entradas");

        const mov = { tipo:"entrada", rutaId, almacenId, productoId, cantidad:cant, ts:serverTimestamp() };

        const batch = writeBatch(db);
        batch.set(exisRef, { stock: increment(+cant), upd: serverTimestamp(), almacenId, productoId }, {merge:true});
        batch.set(doc(logRef), mov);
        await batch.commit();

        state.entradas.unshift({ ...mov, ts:new Date() });
        pintaEntradas();
        cantidad.value = "";
        toast(`Entrada registrada: +${cant} → ${almacenId} (ruta ${rutaId}).`, true);
      }catch(e){
        console.error(e);
        toast("No se pudo registrar la entrada.");
      }
    });

    function pintaEntradas(){
      movList.innerHTML = state.entradas.map(m=>{
        const prod = state.productos.find(p=>p.id===m.productoId);
        const nombre = prod?.descripcion || prod?.nombre || m.productoId;
        return `<div class="item">
          <div><b>${nombre}</b><div class="muted">Prod: ${m.productoId}</div></div>
          <div><span class="pill">+${m.cantidad}</span> <span class="pill">${m.almacenId}</span> <span class="pill">${m.rutaId}</span></div>
        </div>`;
      }).join("") || `<div class="muted" style="padding:8px 10px">Sin entradas en esta sesión.</div>`;
    }

    // === Init ===
    (async function init(){
      await Promise.all([cargarRutas(), cargarAlmacenes(), cargarProductos()]);
      renderAlmacenes(); // inicial
    })();
  </script>
</body>
</html>
