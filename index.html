<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Rutas – Almacenes</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --resalte:#0c6cbd; --bg:linear-gradient(to right,#00416A,#E4E5E6);
      --card:#fff; --muted:#6b7280; --shadow:0 6px 18px rgba(0,0,0,.18); --radius:14px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Poppins',system-ui,Arial; background:var(--bg); color:#111; }
    header{
      position:sticky; top:0; z-index:10; height:56px;
      display:flex; align-items:center; justify-content:center; gap:10px;
      color:#fff; font-weight:700; background:rgba(0,0,0,.55); backdrop-filter:blur(4px);
    }
    main{ max-width:960px; margin:16px auto; padding:0 12px; display:grid; gap:14px; }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .card h3{ margin:0; padding:12px 14px; background:var(--azul); color:#fff; font-size:16px }
    .card .body{ padding:14px; display:grid; gap:10px }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    label{ font-size:13px; color:#111; display:block; margin-bottom:4px }
    input, textarea, select{
      width:100%; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:15px; outline:none;
    }
    textarea{ resize:vertical }
    .btn{
      border:none; padding:12px 14px; border-radius:12px; color:#fff; font-weight:700; cursor:pointer;
      background:linear-gradient(180deg,var(--resalte),#094d85); box-shadow:var(--shadow);
    }
    .btn:active{ transform:translateY(1px) }
    .btn.sec{ background:linear-gradient(180deg,#6b7280,#374151) }
    .btn.danger{ background:linear-gradient(180deg,#ef4444,#b91c1c) }
    table{ width:100%; border-collapse:collapse }
    thead th{ background:#f3f4f6; text-align:left; padding:10px; font-size:13px; position:sticky; top:0 }
    tbody td{ border-top:1px solid #e5e7eb; padding:10px; font-size:14px; vertical-align:top }
    .muted{ color:var(--muted) }
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff }
    .ok{ background:#1e8e3e } .off{ background:#9ca3af }
  </style>
</head>
<body>
<header>Gestión de Almacenes – Ruta de Venta</header>

<main>
  <!-- FORMULARIO -->
  <section class="card">
    <h3>Nuevo / Editar almacén</h3>
    <div class="body">
      <div class="row">
        <div>
          <label>Ruta</label>
          <select id="rutaId">
            <option value="ruta_1">ruta_1</option>
            <option value="ruta_2">ruta_2</option>
          </select>
        </div>
        <div>
          <label>ID de almacén (docId)</label>
          <input id="almId" placeholder="p.ej. matriz, bodega_centro">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="almNombre" placeholder="Matriz / Bodega Fundidora">
        </div>
        <div>
          <label>Ciudad</label>
          <input id="almCiudad" placeholder="Linares, N.L.">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Teléfono</label>
          <input id="almTel" placeholder="(821) 2121805">
        </div>
        <div>
          <label>Responsable</label>
          <input id="almResp" placeholder="Nombre del encargado">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Latitud</label>
          <input id="almLat" type="number" step="0.000001" placeholder="24.856321">
        </div>
        <div>
          <label>Longitud</label>
          <input id="almLng" type="number" step="0.000001" placeholder="-99.567890">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Capacidad (opcional)</label>
          <input id="almCap" type="number" step="0.01" placeholder="m² o pallets">
        </div>
        <div style="display:flex; align-items:center; gap:8px; padding-top:22px">
          <input id="almActivo" type="checkbox" checked>
          <label for="almActivo" style="margin:0">Activo</label>
        </div>
      </div>

      <div>
        <label>Dirección</label>
        <input id="almDir" placeholder="Calle, número, colonia">
      </div>

      <div>
        <label>Notas</label>
        <textarea id="almNotas" rows="2" placeholder="Observaciones…"></textarea>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" id="btnGuardar">Guardar</button>
        <button class="btn sec" id="btnLimpiar" type="button">Limpiar</button>
      </div>
    </div>
  </section>

  <!-- LISTA -->
  <section class="card">
    <h3>Almacenes de la ruta</h3>
    <div class="body" style="padding:0">
      <div style="padding:10px 14px; display:flex; gap:10px; align-items:center;">
        <span class="muted">Ruta:</span>
        <select id="rutaLista" style="max-width:220px"></select>
        <button class="btn sec" id="btnRefrescar" type="button" style="margin-left:auto">Refrescar</button>
      </div>
      <div style="max-height:60vh; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Almacén</th>
              <th>Ubicación</th>
              <th>Contacto</th>
              <th>Estado</th>
              <th style="width:160px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbodyAlm"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Firebase + lógica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, doc, setDoc, getDocs, getDoc, updateDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === MISMO PROYECTO QUE TU POS ===
  const firebaseConfig = {
    apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
    authDomain: "inventariopv-643f1.firebaseapp.com",
    projectId: "inventariopv-643f1",
    storageBucket: "inventariopv-643f1.appspot.com",
    messagingSenderId: "96242533231",
    appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ====== UI refs ======
  const rutaId       = document.getElementById('rutaId');
  const almId        = document.getElementById('almId');
  const almNombre    = document.getElementById('almNombre');
  const almCiudad    = document.getElementById('almCiudad');
  const almTel       = document.getElementById('almTel');
  const almResp      = document.getElementById('almResp');
  const almLat       = document.getElementById('almLat');
  const almLng       = document.getElementById('almLng');
  const almCap       = document.getElementById('almCap');
  const almActivo    = document.getElementById('almActivo');
  const almDir       = document.getElementById('almDir');
  const almNotas     = document.getElementById('almNotas');
  const btnGuardar   = document.getElementById('btnGuardar');
  const btnLimpiar   = document.getElementById('btnLimpiar');

  const rutaLista    = document.getElementById('rutaLista');
  const btnRefrescar = document.getElementById('btnRefrescar');
  const tbodyAlm     = document.getElementById('tbodyAlm');

  // sincroniza select de la lista con el del form
  function syncRutaLista(){
    rutaLista.innerHTML = '';
    [...rutaId.options].forEach(opt=>{
      const o = document.createElement('option');
      o.value = opt.value; o.textContent = opt.textContent;
      rutaLista.appendChild(o);
    });
    rutaLista.value = rutaId.value;
  }
  rutaId.addEventListener('change', syncRutaLista);

  // Helpers
  const $money = n => '$'+(Number(n)||0).toFixed(2);
  const safeId = s => (s||'').toString().trim();

  function limpiar(){
    almId.value=''; almNombre.value=''; almCiudad.value='';
    almTel.value=''; almResp.value=''; almLat.value='';
    almLng.value=''; almCap.value=''; almDir.value='';
    almNotas.value=''; almActivo.checked=true;
    almId.focus();
  }

  // Guardar (create/update) almacén
  async function guardarAlmacen(){
    const ruta = safeId(rutaId.value);
    const id   = safeId(almId.value);
    if(!ruta){ alert('Selecciona una ruta'); return; }
    if(!id){ alert('Escribe el ID del almacén'); return; }

    const payload = {
      nombre: safeId(almNombre.value) || id,
      ciudad: safeId(almCiudad.value) || null,
      telefono: safeId(almTel.value) || null,
      responsable: safeId(almResp.value) || null,
      direccion: safeId(almDir.value) || null,
      notas: safeId(almNotas.value) || null,
      capacidad: Number(almCap.value||0) || null,
      activo: !!almActivo.checked,
      geo: {
        lat: almLat.value ? Number(almLat.value) : null,
        lng: almLng.value ? Number(almLng.value) : null
      },
      actualizado: serverTimestamp(),
      creado: serverTimestamp()
    };

    await setDoc(doc(db, 'rutas_venta', ruta, 'almacenes', id), payload, { merge:true });
    alert('Almacén guardado');
    await cargarAlmacenes();
    // precarga el doc recién guardado para edición posterior
    cargarEnFormulario(ruta, id);
  }

  // Listar almacenes de la ruta seleccionada en la lista
  async function cargarAlmacenes(){
    const ruta = safeId(rutaLista.value);
    tbodyAlm.innerHTML = '<tr><td class="muted" colspan="5" style="padding:12px">Cargando…</td></tr>';
    try{
      const snap = await getDocs(collection(db, 'rutas_venta', ruta, 'almacenes'));
      const rows = [];
      snap.forEach(d=>{
        const a = d.data();
        rows.push({
          id:d.id,
          nombre:a.nombre||d.id,
          ciudad:a.ciudad||'',
          tel:a.telefono||'',
          resp:a.responsable||'',
          activo:(a.activo!==false),
          lat:a.geo?.lat??null, lng:a.geo?.lng??null,
          dir:a.direccion||'', notas:a.notas||''
        });
      });
      if(!rows.length){
        tbodyAlm.innerHTML = '<tr><td class="muted" colspan="5" style="padding:12px">Sin almacenes</td></tr>';
        return;
      }
      tbodyAlm.innerHTML = '';
      rows.sort((a,b)=>a.nombre.localeCompare(b.nombre));
      rows.forEach(a=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div style="font-weight:600">${a.nombre}</div>
            <div class="muted">${a.id}</div>
            <div class="muted">${a.dir||''}</div>
          </td>
          <td>
            <div>${a.ciudad||''}</div>
            <div class="muted">${(a.lat!=null&&a.lng!=null)?(a.lat+', '+a.lng):''}</div>
          </td>
          <td>
            <div>${a.tel||''}</div>
            <div class="muted">${a.resp||''}</div>
          </td>
          <td>
            <span class="chip ${a.activo?'ok':'off'}">${a.activo?'ACTIVO':'INACTIVO'}</span>
          </td>
          <td>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn sec" data-act="edit" data-id="${a.id}">Editar</button>
              <button class="btn" data-act="toggle" data-id="${a.id}">${a.activo?'Desactivar':'Activar'}</button>
            </div>
          </td>
        `;
        tbodyAlm.appendChild(tr);
      });
    }catch(e){
      console.error(e);
      tbodyAlm.innerHTML = '<tr><td class="muted" colspan="5" style="padding:12px;color:#b91c1c">Error al cargar</td></tr>';
    }
  }

  // Cargar un doc al formulario
  async function cargarEnFormulario(ruta, id){
    try{
      const snap = await getDoc(doc(db, 'rutas_venta', ruta, 'almacenes', id));
      if(!snap.exists()){ alert('No existe ese almacén'); return; }
      const a = snap.data();
      rutaId.value = ruta;
      syncRutaLista();

      almId.value     = id;
      almNombre.value = a.nombre||'';
      almCiudad.value = a.ciudad||'';
      almTel.value    = a.telefono||'';
      almResp.value   = a.responsable||'';
      almLat.value    = (a.geo?.lat??'');
      almLng.value    = (a.geo?.lng??'');
      almCap.value    = (a.capacidad??'');
      almDir.value    = a.direccion||'';
      almNotas.value  = a.notas||'';
      almActivo.checked = (a.activo!==false);
      window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ console.error(e); alert('No se pudo abrir el almacén'); }
  }

  // Toggle activo
  async function toggleActivo(id){
    const ruta = safeId(rutaLista.value);
    const ref  = doc(db,'rutas_venta',ruta,'almacenes',id);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    const activo = !(snap.data().activo!==false); // true si estaba activo
    await updateDoc(ref,{ activo: !activo, actualizado: serverTimestamp() });
    await cargarAlmacenes();
  }

  // Eventos
  btnGuardar.addEventListener('click', guardarAlmacen);
  btnLimpiar.addEventListener('click', (e)=>{ e.preventDefault(); limpiar(); });

  syncRutaLista();
  btnRefrescar.addEventListener('click', cargarAlmacenes);
  rutaLista.addEventListener('change', cargarAlmacenes);

  // Delegación en la tabla
  tbodyAlm.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.getAttribute('data-act');
    const id  = btn.getAttribute('data-id');
    const ruta = safeId(rutaLista.value);
    if(act==='edit')   cargarEnFormulario(ruta,id);
    if(act==='toggle') toggleActivo(id);
  });

  // Primera carga
  await cargarAlmacenes();
</script>
</body>
</html>
