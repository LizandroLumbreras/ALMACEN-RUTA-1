<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Entradas a Almacén – Rutas</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --azul:#00416A; --gris:#E4E5E6; --ok:#1e8e3e; --warn:#b45309;
      --bg: linear-gradient(to right, #00416A, #E4E5E6);
      --card: rgba(255,255,255,.92); --muted: rgba(0,0,0,.55); --shadow:0 8px 24px rgba(0,0,0,.18);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',system-ui,Arial; color:#0f172a; background:var(--bg);
      display:flex; flex-direction:column;
    }
    header{ color:#fff; padding:14px 18px; font-weight:700; text-align:center; letter-spacing:.3px;}
    main{ flex:1; display:flex; justify-content:center; padding:18px}
    .card{
      width:100%; max-width:980px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px; backdrop-filter: blur(4px);
    }
    h2{margin:6px 0 14px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:end; margin-bottom:12px}
    label{font-size:12px; color:var(--muted)}
    select,input,button{
      width:100%; padding:10px 12px; border:1px solid #d8dde6; border-radius:10px; font-family:inherit; font-size:14px;
      background:#fff;
    }
    .col{flex:1 1 180px; min-width:180px}
    .col.small{flex:0 0 120px; min-width:120px}
    .col.xs{flex:0 0 90px; min-width:90px}
    .actions{display:flex; gap:10px; margin-top:10px}
    .btn{border:none; cursor:pointer; background:#00416A; color:#fff; font-weight:600; padding:11px 14px; border-radius:10px;}
    .btn.secondary{background:#0c6cbd}
    .btn.ghost{background:#fff; border:1px solid #cfd6e4; color:#0f172a}
    .btn.warn{background:#b45309}
    .tag{display:inline-block; padding:4px 8px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; font-size:12px}
    .folio{
      display:inline-block; padding:8px 12px; border-radius:10px; background:#ecfdf5; border:1px solid #bbf7d0;
      font-weight:700; color:#065f46; letter-spacing:.5px; min-width:140px; text-align:center;
    }
    table{width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border-radius:12px; overflow:hidden}
    th,td{padding:10px 10px; border-bottom:1px solid #eef2f7; text-align:left; font-size:14px}
    th{background:#f8fafc; color:#334155; position:sticky; top:0}
    tbody tr:hover{background:#f6faff}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .empty{padding:16px; text-align:center; color:var(--muted)}
    .footer{display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-top:12px; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>Entradas a Almacén – Rutas</header>
  <main>
    <div class="card">
      <h2>Captura de Entradas</h2>

      <div class="row">
        <div class="col">
          <label for="selAlmacen">Almacén destino</label>
          <select id="selAlmacen">
            <option value="">— selecciona —</option>
            <option value="Almacen_Ruta_1">Almacen_Ruta_1</option>
            <option value="Almacen_Ruta_2">Almacen_Ruta_2</option>
          </select>
        </div>
        <div class="col">
          <label for="txtCodigo">Código</label>
          <input id="txtCodigo" placeholder="Escanea o escribe el código" autocomplete="off"/>
        </div>
        <div class="col small">
          <label for="txtCant">Cantidad</label>
          <input id="txtCant" type="number" inputmode="numeric" min="1" step="1" value="1"/>
        </div>
        <div class="col xs">
          <button class="btn" id="btnAgregar">Agregar</button>
        </div>
      </div>

      <div class="row" style="align-items:center">
        <div class="col">
          <span class="muted">Folio actual:</span>
          <span id="folioPreview" class="folio">—</span>
        </div>
      </div>

      <div class="muted" style="margin-bottom:6px">
        La búsqueda intenta <span class="tag">productos/{id}</span> y luego
        <span class="tag">where(codigo|codigoBarra|EAN|sku|clave == código)</span>.
      </div>

      <table id="tabla">
        <thead>
          <tr>
            <th style="width:120px">Código</th>
            <th>Descripción</th>
            <th class="right" style="width:120px">Cantidad</th>
            <th class="right" style="width:100px">Acción</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr class="empty"><td colspan="4">Sin partidas. Agrega códigos para empezar.</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="right">Total de piezas</td>
            <td class="right" id="totalPzas">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="footer">
        <button class="btn ghost" id="btnLimpiar">Limpiar lista</button>
        <button class="btn secondary" id="btnGuardar">Guardar entradas</button>
      </div>

      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>
  </main>

  <!-- Firebase v9+ (modular) por CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, limit,
      getDocs, serverTimestamp, increment, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // === TU CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- UI refs
    const selAlmacen = document.getElementById('selAlmacen');
    const txtCodigo  = document.getElementById('txtCodigo');
    const txtCant    = document.getElementById('txtCant');
    const btnAgregar = document.getElementById('btnAgregar');
    const btnGuardar = document.getElementById('btnGuardar');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const tbody      = document.getElementById('tbody');
    const totalPzas  = document.getElementById('totalPzas');
    const statusEl   = document.getElementById('status');
    const folioPreviewEl = document.getElementById('folioPreview');

    // Doc de consecutivos
    const FOLIOS_DOC = ['consecutivos','Folios_Entradas_Almacenes_Rutas'];

    // Prefijos y padding por almacén (según tu ejemplo)
    const FOLIO_FMT = {
      'Almacen_Ruta_1': { prefix:'R1-', pad:5 },
      'Almacen_Ruta_2': { prefix:'R2-', pad:5 },
    };

    let partidas = []; // {codigo, descripcion, cantidad}

    // Helpers UI
    function setStatus(msg, ok=false){ statusEl.textContent = msg || ""; statusEl.style.color = ok ? "var(--ok)" : "var(--muted)"; }
    function escapeHtml(s){ return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function getDescripcion(d){
      return d.concepto ?? d.descripcion ?? d.Descripcion ?? d.nombre ?? d.Nombre ?? d.detalle ?? d.descripcionCorta ?? "(Sin descripción)";
    }
    function getCodigo(d, fallback){
      return d.codigo ?? d.Codigo ?? d.codigoBarra ?? d.codigo_barras ?? d.EAN ?? d.ean ?? d.sku ?? d.clave ?? fallback;
    }
    function formatFolio(almacen, num){
      const fmt = FOLIO_FMT[almacen] || {prefix:'R-', pad:5};
      return `${fmt.prefix}${String(num).padStart(fmt.pad,'0')}`;
    }

    async function refreshFolioPreview(){
      const almacen = selAlmacen.value.trim();
      if(!almacen){ folioPreviewEl.textContent = '—'; return; }
      try{
        const ref = doc(db, ...FOLIOS_DOC);
        const snap = await getDoc(ref);
        const current = (snap.exists() && typeof snap.data()?.[almacen] === 'number') ? snap.data()[almacen] : 0;
        folioPreviewEl.textContent = formatFolio(almacen, current + 1);
      }catch(e){
        console.warn(e); folioPreviewEl.textContent = '—';
      }
    }

    function render(){
      tbody.innerHTML = "";
      if(partidas.length === 0){
        const tr = document.createElement('tr'); tr.className = "empty";
        tr.innerHTML = `<td colspan="4">Sin partidas. Agrega códigos para empezar.</td>`;
        tbody.appendChild(tr);
        totalPzas.textContent = "0";
        return;
      }
      let total = 0;
      partidas.forEach((p, idx)=>{
        total += p.cantidad;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="tag">${p.codigo}</span></td>
          <td>${escapeHtml(p.descripcion || '')}</td>
          <td class="right">${p.cantidad}</td>
          <td class="right"><button class="btn warn" data-idx="${idx}">Quitar</button></td>
        `;
        tbody.appendChild(tr);
      });
      totalPzas.textContent = String(total);
      tbody.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const i = Number(e.currentTarget.dataset.idx);
          partidas.splice(i,1);
          render();
        });
      });
    }

    // Buscar producto
    async function buscarProductoPorCodigo(codigoEntrada){
      const codigoStr = String((codigoEntrada ?? "")).trim();
      if(!codigoStr) return null;

      try{
        const refById = doc(db, "productos", codigoStr);
        const sById   = await getDoc(refById);
        if (sById.exists()) {
          const d = sById.data();
          return { id: sById.id, ...d, codigo: getCodigo(d, codigoStr), descripcion: getDescripcion(d) };
        }
      }catch(e){ console.warn("Lookup by ID:", e); }

      const fields = ["codigo","Codigo","codigoBarra","codigo_barras","EAN","ean","sku","clave"];
      const candidates = new Set([codigoStr]);
      const n = Number(codigoStr); if (Number.isFinite(n)) candidates.add(n);

      for (const f of fields){
        for (const v of candidates){
          try{
            const qref = query(collection(db,"productos"), where(f,"==",v), limit(1));
            const qs = await getDocs(qref);
            if (!qs.empty){
              const s = qs.docs[0], d = s.data();
              return { id: s.id, ...d, codigo: getCodigo(d, codigoStr), descripcion: getDescripcion(d) };
            }
          }catch(e){ console.warn(`Lookup ${f}==${v} falló:`, e); }
        }
      }
      return null;
    }

    // Reservar UN folio de forma atómica por almacén
    async function reservarFolio(almacen){
      const num = await runTransaction(db, async (tx)=>{
        const ref = doc(db, ...FOLIOS_DOC);
        const snap = await tx.get(ref);
        let curr = 0;
        if (snap.exists() && typeof snap.data()[almacen] === 'number') curr = snap.data()[almacen];
        const next = curr + 1;
        tx.set(ref, { [almacen]: next }, { merge:true });
        return next;
      });
      return num;
    }

    // UI events
    selAlmacen.addEventListener('change', refreshFolioPreview);

    btnAgregar.addEventListener('click', async ()=>{
      const almacen = selAlmacen.value.trim();
      const codigo  = txtCodigo.value.trim();
      const cant    = Number(txtCant.value);

      if(!almacen){ setStatus("Selecciona el almacén destino."); return; }
      if(!codigo){ setStatus("Escribe un código."); txtCodigo.focus(); return; }
      if(!Number.isFinite(cant) || cant<=0){ setStatus("Cantidad inválida."); txtCant.focus(); return; }

      setStatus("Buscando producto…");
      try{
        const prod = await buscarProductoPorCodigo(codigo);
        if(!prod){ setStatus("No se encontró el producto en ‘productos’."); return; }

        const code = getCodigo(prod, codigo);
        const i = partidas.findIndex(x=>x.codigo===code);
        if(i>=0){
          partidas[i].cantidad += cant;
        }else{
          partidas.push({ codigo: code, descripcion: getDescripcion(prod), cantidad: cant });
        }
        render();
        setStatus("Producto agregado a la lista.", true);
        txtCodigo.value = ""; txtCant.value = 1; txtCodigo.focus();
      }catch(err){
        console.error(err);
        setStatus("Error buscando producto. Revisa la consola.");
      }
    });

    btnGuardar.addEventListener('click', async ()=>{
      const almacen = selAlmacen.value.trim();
      if(!almacen){ setStatus("Selecciona el almacén destino."); return; }
      if(partidas.length===0){ setStatus("No hay partidas para guardar."); return; }

      setStatus("Reservando folio…");
      try{
        const numero = await reservarFolio(almacen);
        const folio = formatFolio(almacen, numero);
        const now   = serverTimestamp();

        // Encabezado
        const totalPzasGrupo = partidas.reduce((a,b)=>a + Number(b.cantidad||0), 0);
        const encRef = doc(db, 'almacenes', almacen, 'entradas', folio);
        await setDoc(encRef, {
          folio, almacen, createdAt: now,
          partidas: partidas.length,
          piezas: totalPzasGrupo,
          origen: 'captura_web'
        }, { merge:true });

        // Detalles + inventario
        for(const p of partidas){
          const detRef = doc(collection(encRef, 'detalles'), p.codigo);
          await setDoc(detRef, {
            codigo: p.codigo,
            descripcion: p.descripcion || "",
            cantidad: Number(p.cantidad),
            createdAt: now
          });

          const invRef = doc(db, 'almacenes', almacen, 'inventario', p.codigo);
          await setDoc(invRef, {
            codigo: p.codigo,
            descripcion: p.descripcion || "",
            updatedAt: now,
            origen: 'captura_web',
            ultimoFolio: folio,
            modo: 'entrada'
          }, { merge: true });
          await updateDoc(invRef, { cantidad: increment(Number(p.cantidad)) });
        }

        setStatus(`Guardado OK. Folio: ${folio}`, true);
        partidas = []; render();
        await refreshFolioPreview(); // muestra siguiente folio disponible
      }catch(err){
        console.error(err);
        setStatus("Ocurrió un error al guardar/reservar folio. Revisa la consola.");
      }
    });

    btnLimpiar.addEventListener('click', ()=>{
      partidas = []; render(); setStatus("Lista vaciada."); 
    });

    txtCodigo.addEventListener('keydown', e=>{ if(e.key==='Enter') btnAgregar.click(); });
    txtCant.addEventListener('keydown',  e=>{ if(e.key==='Enter')  btnAgregar.click(); });

    // Inicial
    refreshFolioPreview();
  </script>
</body>
</html>
