<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Registrar ENTRADA – Cigarro (con selector de ruta)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
  :root{ --azul:#00416A; --gris:#5b6b7a; --ok:#1e8e3e; --bg:linear-gradient(to right,#00416A,#E4E5E6);
         --card:rgba(255,255,255,.96); --shadow:0 10px 28px rgba(0,0,0,.16); --radius:16px; }
  *{box-sizing:border-box}
  body{ margin:0; font-family:'Poppins',system-ui,Arial; background:var(--bg); color:#0f172a;
        min-height:100vh; padding:20px; display:flex; justify-content:center; }
  .wrap{width:100%; max-width:1000px; display:grid; gap:18px}
  header{ background:#003456; color:#fff; padding:14px 16px; border-radius:var(--radius);
          box-shadow:var(--shadow); text-align:center; font-weight:600; }
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; }
  h2{margin:.2rem 0 1rem; font-size:1.1rem; color:#0b2740}
  label{font-size:.9rem; display:block; margin:10px 0 6px}
  input,select,textarea{
    width:100%; padding:10px 12px; border:1px solid #cfd8e3; border-radius:10px; background:#fff;
    font-family:inherit; font-size:.95rem;
  }
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .btn{ background:var(--azul); color:#fff; border:none; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .muted{color:var(--gris); font-size:.9rem}
  .ok{color:var(--ok); font-weight:600}
  .hr{height:1px; background:#e6e9ef; margin:14px 0}
  table{width:100%; border-collapse:collapse; font-size:.92rem}
  th,td{border-bottom:1px dashed #e2e8f0; padding:8px}
  th{text-align:left; color:#344}
  tfoot td{font-weight:700}
  .right{text-align:right}
  .pill{padding:3px 8px; border-radius:999px; background:#eef2f7; font-size:.78rem}
</style>
</head>
<body>
<div class="wrap">
  <header>Registrar ENTRADA – Cigarro · La Proveedora</header>

  <!-- Selección de Ruta y Folio -->
  <section class="card">
    <div class="row">
      <div>
        <label for="selRuta">Ruta</label>
        <select id="selRuta"></select>
      </div>
      <div>
        <label>Folio próximo</label>
        <div><span id="folioNext" class="pill">Cargando…</span></div>
      </div>
    </div>
    <div class="muted" id="folioHint">El folio es por ruta y se incrementa al guardar.</div>
  </section>

  <!-- Cabecera -->
  <section class="card">
    <h2>Datos de cabecera</h2>
    <div class="row">
      <div>
        <label for="fecha">Fecha</label>
        <input id="fecha" type="date"/>
      </div>
      <div>
        <label for="almacen">Recibe en almacén</label>
        <select id="almacen"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="proveedor">Proveedor / Quién entrega</label>
        <input id="proveedor" placeholder="Nombre de proveedor o persona"/>
      </div>
      <div>
        <label for="quienRecibe">Quién recibe</label>
        <select id="quienRecibe"></select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="origen">Origen (opcional)</label>
        <input id="origen" placeholder="Texto libre"/>
      </div>
      <div>
        <label for="notas">Notas</label>
        <input id="notas" placeholder="Observaciones (opcional)"/>
      </div>
    </div>

    <div style="margin-top:10px">
      <button id="btnContinuar" class="btn">Continuar</button>
      <span id="msgHead" class="muted"></span>
    </div>
  </section>

  <!-- Partidas -->
  <section class="card" id="partidasCard" style="display:none">
    <h2>Partidas</h2>
    <div class="row">
      <div>
        <label for="producto">Producto</label>
        <select id="producto"></select>
      </div>
      <div>
        <label for="cantidad">Cantidad</label>
        <input id="cantidad" type="number" min="1" step="1" placeholder="0"/>
      </div>
    </div>
    <div style="margin-top:10px">
      <button id="btnAgregar" class="btn">Agregar entrada (+)</button>
      <span id="msgPartida" class="muted"></span>
    </div>

    <div class="hr"></div>
    <table>
      <thead>
        <tr><th>Producto</th><th class="right">Cantidad</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
      <tfoot>
        <tr><td>Total partidas</td><td class="right" id="totalCant">0</td></tr>
      </tfoot>
    </table>

    <div class="hr"></div>
    <button id="btnGuardar" class="btn">Guardar ENTRADA</button>
    <span id="msgGuardar" class="muted"></span>
  </section>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import {
  initializeFirestore,
  collection, doc, getDoc, getDocs, setDoc, addDoc, query, orderBy,
  serverTimestamp, runTransaction, writeBatch, increment
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// Config (tu proyecto)
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
const app = initializeApp(firebaseConfig);
const db  = initializeFirestore(app, { experimentalAutoDetectLongPolling:true, useFetchStreams:false });

const $ = id => document.getElementById(id);
const selRuta = $("selRuta"), folioNext = $("folioNext");
const fecha = $("fecha"), almacen = $("almacen"), proveedor = $("proveedor"), quienRecibe = $("quienRecibe");
const origen = $("origen"), notas = $("notas");
const btnContinuar = $("btnContinuar"), msgHead = $("msgHead");
const partidasCard = $("partidasCard");
const producto = $("producto"), cantidad = $("cantidad");
const btnAgregar = $("btnAgregar"), msgPartida = $("msgPartida");
const tbody = $("tbody"), totalCant = $("totalCant");
const btnGuardar = $("btnGuardar"), msgGuardar = $("msgGuardar");

const state = { rutas:[], almacenes:[], usuarios:[], productos:[], items:[], rutaId:null, folio:0 };

function fmtFolio(n, width=6){ return String(n).padStart(width,"0"); }
function setMsg(el, text, ok=false){ el.textContent = text; el.className = ok ? "ok" : "muted"; }

// --- Carga catálogos ---
async function loadRutas(){
  const snap = await getDocs(collection(db, "rutas_venta"));
  state.rutas = snap.docs.map(d=>({id:d.id}));
  selRuta.innerHTML = state.rutas.map(r=>`<option value="${r.id}">${r.id}</option>`).join("") || `<option value="">(sin rutas)</option>`;
  state.rutaId = selRuta.value || null;
}
async function loadAlmacenes(){
  const q = query(collection(db, "almacenes"), orderBy("id"));
  const snap = await getDocs(q);
  state.almacenes = snap.docs.map(d=>({id:d.id, ...d.data()}));
  almacen.innerHTML = state.almacenes.map(a=>`<option value="${a.id}">${a.nombre||a.id}</option>`).join("") 
    || `<option value="">(sin almacenes)</option>`;
}
async function loadUsuarios(){
  const snap = await getDocs(collection(db, "usuarios_ruta"));
  state.usuarios = snap.docs.map(d=>({id:d.id, ...d.data()}));
  if(state.usuarios.length){
    quienRecibe.innerHTML = state.usuarios
      .sort((a,b)=>(a.nombre||a.id).localeCompare(b.nombre||b.id))
      .map(u=>`<option value="${u.nombre||u.id}">${u.nombre||u.id}</option>`).join("");
  }else{
    // Fallback si no existe la colección: deja escribir a mano
    quienRecibe.outerHTML = `<input id="quienRecibe" placeholder="Nombre quien recibe"/>`;
  }
}
async function loadProductos(){
  const snap = await getDocs(collection(db, "productos"));
  state.productos = snap.docs.map(d=>({id:d.id, ...d.data()}));
  producto.innerHTML = state.productos
    .sort((a,b)=>(a.descripcion||a.id).localeCompare(b.descripcion||b.id))
    .map(p=>`<option value="${p.id}">${(p.descripcion||p.nombre||p.id)} ${p.codigo?("· "+p.codigo):""}</option>`).join("")
    || `<option value="">(sin productos)</option>`;
}

// --- Folio por ruta ---
async function refreshFolio(){
  if(!state.rutaId){ folioNext.textContent = "—"; return; }
  const ref = doc(db, "rutas_venta", state.rutaId, "consecutivos", "entradas");
  const snap = await getDoc(ref);
  const n = snap.exists() && typeof snap.data().proximo === "number" ? snap.data().proximo : 1;
  state.folio = n;
  folioNext.textContent = fmtFolio(n);
}

// --- Eventos UI ---
selRuta.addEventListener("change", async ()=>{
  state.rutaId = selRuta.value || null;
  await refreshFolio();
});

btnContinuar.addEventListener("click", ()=>{
  if(!state.rutaId){ setMsg(msgHead,"Selecciona una ruta."); return; }
  if(!fecha.value){ setMsg(msgHead,"Selecciona la fecha."); return; }
  if(!almacen.value){ setMsg(msgHead,"Selecciona el almacén de recepción."); return; }
  if(!proveedor.value){ setMsg(msgHead,"Indica proveedor / quién entrega."); return; }
  const qr = document.getElementById("quienRecibe").value || "";
  if(!qr){ setMsg(msgHead,"Indica quién recibe."); return; }
  partidasCard.style.display = "block";
  setMsg(msgHead, "Ok, captura las partidas…", true);
});

btnAgregar.addEventListener("click", ()=>{
  const pid = producto.value;
  const cant = Number(cantidad.value);
  if(!pid){ setMsg(msgPartida,"Elige un producto."); return; }
  if(!cant || cant<=0){ setMsg(msgPartida,"Cantidad inválida."); return; }
  state.items.push({ productoId: pid, cantidad: cant });
  cantidad.value = "";
  renderItems();
  setMsg(msgPartida, "Partida agregada.", true);
});

function renderItems(){
  tbody.innerHTML = state.items.map(it=>{
    const p = state.productos.find(x=>x.id===it.productoId);
    const nombre = p?.descripcion || p?.nombre || it.productoId;
    return `<tr><td>${nombre} <div class="muted">${it.productoId}</div></td><td class="right">${it.cantidad}</td></tr>`;
  }).join("");
  const total = state.items.reduce((a,b)=>a+b.cantidad,0);
  totalCant.textContent = total;
}

// --- Guardar entrada ---
btnGuardar.addEventListener("click", async ()=>{
  if(!state.items.length){ setMsg(msgGuardar,"Agrega al menos una partida."); return; }
  btnGuardar.disabled = true;

  try{
    const rutaId = state.rutaId;
    const who = document.getElementById("quienRecibe").value || "";
    const almId = almacen.value;

    // 1) Obtener y avanzar folio con transaction
    const consecRef = doc(db, "rutas_venta", rutaId, "consecutivos", "entradas");
    const folioUsado = await runTransaction(db, async (tx)=>{
      const snap = await tx.get(consecRef);
      const actual = snap.exists() && typeof snap.data().proximo==="number" ? snap.data().proximo : 1;
      const siguiente = actual + 1;
      tx.set(consecRef, { proximo: siguiente, upd: serverTimestamp() }, { merge:true });
      return actual;
    });

    const folioStr = fmtFolio(folioUsado);

    // 2) Crear header y partidas
    const entradaRef = doc(db, "rutas_venta", rutaId, "entradas", folioStr);
    const partidasCol = collection(entradaRef, "partidas");

    const header = {
      folio: folioUsado,
      folioStr,
      fecha: fecha.value,
      proveedor: proveedor.value,
      quienRecibe: who,
      origen: origen.value || "",
      notas: notas.value || "",
      almacenId: almId,
      totalPartidas: state.items.length,
      totalPiezas: state.items.reduce((a,b)=>a+b.cantidad,0),
      createdAt: serverTimestamp()
    };

    const batch = writeBatch(db);
    batch.set(entradaRef, header, {merge:true});

    // 3) Escribir partidas y actualizar stock del almacén (top-level)
    state.items.forEach(it=>{
      const pRef = doc(partidasCol); // autoId
      batch.set(pRef, { productoId: it.productoId, cantidad: it.cantidad });

      const exisRef = doc(db, "almacenes", almId, "existencias", it.productoId);
      batch.set(exisRef, { stock: increment(+it.cantidad), upd: serverTimestamp(), almacenId: almId, productoId: it.productoId }, {merge:true});
    });

    await batch.commit();

    // 4) Reset UI
    state.items = [];
    renderItems();
    await refreshFolio();
    setMsg(msgGuardar, `Entrada ${folioStr} guardada correctamente.`, true);
  }catch(err){
    console.error(err);
    setMsg(msgGuardar, "No se pudo guardar la entrada.");
  }finally{
    btnGuardar.disabled = false;
  }
});

// --- Init ---
(async function init(){
  // Fecha por defecto hoy
  fecha.value = new Date().toISOString().slice(0,10);

  await Promise.all([loadRutas(), loadAlmacenes(), loadUsuarios(), loadProductos()]);
  await refreshFolio();
})();
</script>
</body>
</html>
